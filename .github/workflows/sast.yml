name: SAST (Semgrep)

on:
  push:
    branches: [test, dev]
  pull_request:
    branches: [test, dev]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write   # required for SARIF upload to Code Scanning

jobs:
  semgrep:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # Install Semgrep (CLI)
      - uses: actions/setup-python@v5
        with:
          python-version: "3.x"
      - name: Install Semgrep
        run: python -m pip install --upgrade pip semgrep

      # Run Semgrep -> JSON (for stats) and -> SARIF (for Code Scanning)
      - name: Semgrep JSON (for stats)
        run: |
          semgrep \
            --config p/typescript \
            --config p/react \
            --exclude node_modules \
            --timeout 120 \
            --json -o semgrep.json || true

      - name: Semgrep SARIF (for Code Scanning)
        run: |
          semgrep \
            --config p/typescript \
            --config p/react \
            --exclude node_modules \
            --timeout 120 \
            --sarif -o semgrep.sarif || true

      # Upload SARIF to GitHub "Code scanning alerts"
      - name: Upload SARIF to Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep.sarif

      # Show a summary in the job (counts by severity)
      - name: Summarize Semgrep results
        run: |
          echo "## Semgrep Summary" >> $GITHUB_STEP_SUMMARY
          if [ -f semgrep.json ]; then
            TOTAL=$(jq '.results | length' semgrep.json)
            HIGH=$(jq '[.results[].extra.severity] | map(select(.=="HIGH")) | length' semgrep.json)
            MED=$(jq '[.results[].extra.severity] | map(select(.=="MEDIUM")) | length' semgrep.json)
            LOW=$(jq  '[.results[].extra.severity] | map(select(.=="LOW")) | length' semgrep.json)
            INFO=$(jq '[.results[].extra.severity] | map(select(.=="INFO")) | length' semgrep.json)
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Total findings: ${TOTAL}" >> $GITHUB_STEP_SUMMARY
            echo "- High: ${HIGH}" >> $GITHUB_STEP_SUMMARY
            echo "- Medium: ${MED}" >> $GITHUB_STEP_SUMMARY
            echo "- Low: ${LOW}" >> $GITHUB_STEP_SUMMARY
            echo "- Info: ${INFO}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "> Full details are available in the artifact and in the Security â†’ Code scanning alerts tab." >> $GITHUB_STEP_SUMMARY
          else
            echo "No semgrep.json produced." >> $GITHUB_STEP_SUMMARY
          fi

      # Keep raw outputs as artifacts (handy for grading/demo)
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-results-${{ github.run_id }}
          path: |
            semgrep.json
            semgrep.sarif