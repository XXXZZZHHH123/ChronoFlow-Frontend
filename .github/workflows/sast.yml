name: SAST (Semgrep)

on:
  push:          { branches: [test, dev] }
  pull_request:  { branches: [test, dev] }
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  semgrep:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Semgrep
        run: python -m pip install --upgrade pip semgrep

      # Run Semgrep once → both JSON (for our HTML) and SARIF (for Security tab)
      - name: Semgrep scan (JSON + SARIF)
        run: |
          semgrep scan \
            --config p/owasp-top-ten \
            --config p/javascript \
            --config p/typescript \
            --config p/secrets \
            --include 'src/**/*.{ts,tsx,js,jsx,json,yml,yaml}' \
            --metrics=off \
            --json  -o semgrep.json \
            --sarif -o semgrep.sarif \
            .

      # Build a neat HTML dashboard from semgrep.json (no repo changes needed)
      - name: Generate HTML dashboard
        run: |
          mkdir -p reports
          cat > reports/semgrep-html-report.mjs <<'EOF'
          #!/usr/bin/env node
          const fs = require('fs');
          const [,, inFile, outFile] = process.argv;
          const data = JSON.parse(fs.readFileSync(inFile, 'utf8'));
          const results = (data.results || []);
          const order = { HIGH: 1, MEDIUM: 2, LOW: 3, INFO: 4 };
          results.sort((a,b) => (order[a?.extra?.severity]||99) - (order[b?.extra?.severity]||99));
          const esc = s => String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
          const counts = ['HIGH','MEDIUM','LOW','INFO']
            .reduce((acc,s)=> (acc[s]=results.filter(r=>r?.extra?.severity===s).length, acc), {});
          const row = (r,i) => {
            const sev = esc(r?.extra?.severity || '');
            const id  = esc(r?.check_id || '');
            const msg = esc(r?.extra?.message || '');
            const path = esc(r?.path
              || r?.extra?.path
              || r?.locations?.[0]?.physicalLocation?.artifactLocation?.uri || '');
            const line = (r?.start?.line)
              || (r?.extra?.start?.line)
              || (r?.locations?.[0]?.physicalLocation?.region?.startLine) || '';
            const cwe = Array.isArray(r?.extra?.metadata?.cwe) ? r.extra.metadata.cwe.join(', ') : esc(r?.extra?.metadata?.cwe || '');
            const ref = (r?.extra?.metadata?.references?.[0]) || '';
            return `<tr>
              <td>${i+1}</td>
              <td class="sev ${sev.toLowerCase()}">${sev}</td>
              <td>${id}</td>
              <td>${msg}</td>
              <td>${path}${line ? ':'+line : ''}</td>
              <td>${esc(cwe)}</td>
              <td>${ref ? `<a href="${esc(ref)}" target="_blank" rel="noopener">ref</a>` : ''}</td>
            </tr>`;
          };
          const html = `<!doctype html><meta charset="utf-8">
          <title>Semgrep Report</title>
          <style>
            body{font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;padding:24px;color:#111;background:#fff}
            h1{margin:0 0 12px}
            .summary{display:flex;flex-wrap:wrap;gap:10px;margin:8px 0 18px}
            .badge{padding:6px 10px;border-radius:999px;background:#eee;font-weight:600}
            .badge.high{background:#fde7e9;color:#b00020}
            .badge.medium{background:#fff5d6;color:#8a6200}
            .badge.low{background:#e8f5e9;color:#1e7a1e}
            .badge.info{background:#eef2ff;color:#223}
            table{border-collapse:collapse;width:100%}
            th,td{border:1px solid #e5e7eb;padding:8px;vertical-align:top}
            th{background:#fafafa;text-align:left}
            tbody tr:nth-child(even){background:#fcfcfc}
            .sev.high{color:#b00020;font-weight:700}
            .sev.medium{color:#8a6200;font-weight:700}
            .sev.low{color:#1e7a1e;font-weight:700}
            .footer{margin-top:16px;color:#555}
            code{background:#f6f8fa;padding:1px 4px;border-radius:4px}
          </style>
          <h1>Semgrep Report</h1>
          <div class="summary">
            <div class="badge high">HIGH: ${counts.HIGH}</div>
            <div class="badge medium">MED: ${counts.MEDIUM}</div>
            <div class="badge low">LOW: ${counts.LOW}</div>
            <div class="badge info">INFO: ${counts.INFO}</div>
            <div class="badge">Files scanned: ${(data.paths?.scanned?.length) ?? 'n/a'}</div>
            <div class="badge">Findings: ${results.length}</div>
          </div>
          <table>
            <thead><tr><th>#</th><th>Severity</th><th>Rule</th><th>Message</th><th>Location</th><th>CWE</th><th>Ref</th></tr></thead>
            <tbody>${results.map(row).join('\n')}</tbody>
          </table>
          <div class="footer">Generated from <code>semgrep.json</code>.</div>`;
          fs.writeFileSync(outFile, html);
          console.log('HTML report:', outFile);
          EOF
          node reports/semgrep-html-report.mjs semgrep.json reports/semgrep-report.html

      # Show a quick summary in the job UI
      - name: Job summary
        run: |
          echo "## Semgrep Summary" >> $GITHUB_STEP_SUMMARY
          node -e "const r=require('./semgrep.json');const f=(r.results||[]);const c=s=>f.filter(x=>x.extra?.severity===s).length;console.log('- Findings:',f.length);console.log('- High:',c('HIGH'),'· Medium:',c('MEDIUM'),'· Low:',c('LOW'),'· Info:',c('INFO'))" \
            | tee -a $GITHUB_STEP_SUMMARY

      # Push to Security → Code scanning alerts
      - name: Upload SARIF to Security tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep.sarif

      # Keep the HTML (and raw data) as a downloadable artifact, like ZAP
      - name: Upload SAST artifact (HTML + raw)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: "semgrep-report-${{ github.run_id }}"
          path: |
            reports/semgrep-report.html
            semgrep.json
            semgrep.sarif