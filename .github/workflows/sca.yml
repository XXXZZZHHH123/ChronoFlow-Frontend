name: "sca"

on:
  push:
    branches: [test, dev]
  pull_request:
    branches: [test, dev]
  workflow_dispatch:

jobs:
  sca:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - run: npm ci

      - name: Run npm audit (JSON)
        # don't hard-fail here; we gate on severity in a later step
        run: |
          set -o pipefail
          npm audit --json > audit.json || true

      # Pretty job summary with counts + a table of top findings
      - name: Summarize audit in job summary
        run: |
          node <<'NODE'
          const fs = require('fs');

          const SUMMARY = process.env.GITHUB_STEP_SUMMARY;
          const path = 'audit.json';
          const data = fs.existsSync(path) ? JSON.parse(fs.readFileSync(path, 'utf8')) : {};
          const counts = (data.metadata && data.metadata.vulnerabilities) || data.vulnerabilities || {};
          const crit = counts.critical || 0;
          const high = counts.high || 0;
          const med  = counts.moderate ?? counts.medium ?? 0;
          const low  = counts.low || 0;

          // Collect per-package details (npm v8/v9+ JSON shape)
          const rows = [];
          if (data.vulnerabilities && typeof data.vulnerabilities === 'object') {
            for (const [name, v] of Object.entries(data.vulnerabilities)) {
              const sev = (v.severity || 'info').toLowerCase();
              const via = (v.via || [])
                .map(x => typeof x === 'string' ? x : x.title || x.name || '')
                .filter(Boolean)
                .slice(0, 3)
                .join('; ');
              const fix = v.fixAvailable
                ? (typeof v.fixAvailable === 'object'
                    ? `${v.fixAvailable.name || name}@${v.fixAvailable.version || ''}`.replace(/@$/, '')
                    : 'yes')
                : 'no';
              rows.push({
                name: '`' + name + '`',
                severity: sev,
                range: '`' + (v.range || v.version || '') + '`',
                via: via || '—',
                fix
              });
            }
          }

          const sevRank = s => ({critical:4, high:3, moderate:2, medium:2, low:1, info:0}[s]||0);
          rows.sort((a,b) => sevRank(b.severity) - sevRank(a.severity));

          let md = '';
          md += `## npm audit – Summary\n\n`;
          md += `- **Critical:** ${crit} · **High:** ${high} · **Moderate:** ${med} · **Low:** ${low}\n\n`;

          if (rows.length) {
            md += `### Top findings\n`;
            md += `| Package | Severity | Affected | Via (sample) | Fix available |\n`;
            md += `|---|---|---|---|---|\n`;
            for (const r of rows.slice(0, 20)) {
              md += `| ${r.name} | ${r.severity} | ${r.range} | ${r.via} | ${r.fix} |\n`;
            }
            if (rows.length > 20) {
              md += `\n_…and ${rows.length - 20} more._\n`;
            }
          } else {
            md += `✅ No vulnerabilities found.\n`;
          }

          fs.appendFileSync(SUMMARY, md);
          NODE

      # Gate the build on high/critical (flip to 'false' to never fail on audit)
      - name: Fail on high/critical vulns
        env:
          ENFORCE: "true"   # set to "false" if you only want reporting
        run: |
          node -e "const r=require('./audit.json'); \
            const c=(r.metadata&&r.metadata.vulnerabilities)||r.vulnerabilities||{}; \
            const hi=(c.high||0), cr=(c.critical||0); \
            console.log('High:',hi,'Critical:',cr); \
            if (process.env.ENFORCE==='true' && (hi+cr)>0) { \
              console.error('Failing: high+critical =', hi+cr); process.exit(1) }"

      - name: Upload audit.json artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-${{ github.run_id }}
          path: audit.json